<!-- app/views/horses/index.html.erb -->
<div class="container my-4">
  <div class="row">
    <!-- Left Two Columns: Horse Cards -->
    <div class="col-md-8">

      <div class="d-flex justify-content-between align-items-center mb-1">
        <h1>Stallions</h1>
        <!-- Magnifying Glass Button for Filters (if you use an offcanvas, etc.) -->
        <button class="btn btn-outline-secondary"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#filterOffcanvas"
                aria-controls="filterOffcanvas">
          <i class="fa fa-search"></i>
        </button>
      </div>

      <!-- Row for Horse Cards -->
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 p-3">
        <% @horses.each do |horse| %>
          <div class="col">
            <%= link_to horse_path(horse), class: "text-decoration-none text-dark" do %>
              <div class="card h-100 p-3 rounded-4" style="cursor: pointer; background-color: #e9edc9;">
                <% if horse.pictures.attached? %>
                  <%= cl_image_tag horse.pictures.first.key, transformation: [ radius: 20, gravity: "auto", background: "#e9edc9", width: 500, height: 400, crop: "fill" ] %>
                <% else %>
                  <%= image_tag "backup-image.png",
                      alt: "No Image",
                      class: "card-img-top img-fluid border rounded mb-3",
                      style: "border-color: #ccc;" %>
                <% end %>
                <h5 class="card-title pt-1 mb-0"><%= horse.name %></h5>
                <div class="d-flex flex-column justify-content-between">
                  <div>
                    <strong><%= number_to_currency(horse.stud_fee) %></strong>
                  </div>
                </div>
                <div class="text-center">
                  <button type="button" class="btn quick-view-btn rounded-circle position-absolute top-0 end-0 m-2"
                          data-bs-toggle="modal"
                          data-bs-target="#horseModal-<%= horse.id %>"
                          onclick="event.preventDefault(); event.stopPropagation();">
                    <i class="fa fa-eye"></i>
                  </button>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Modal for each horse -->
          <div class="modal fade" id="horseModal-<%= horse.id %>" tabindex="-1" aria-labelledby="horseModalLabel-<%= horse.id %>" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title fs-4 fw-bold" id="horseModalLabel-<%= horse.id %>"><%= horse.name %></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                  <%= render 'shared/carousel', horse: horse %>
                  <p class="mb-1"><strong>Age:</strong> <%= horse.age %></p>
                  <p class="mb-1"><strong>Breed:</strong> <%= horse.breed %></p>
                  <p class="mb-1"><strong>Pedigree:</strong> <%= horse.pedigree %></p>
                  <p class="mb-1"><strong>Location:</strong> <%= horse.location %></p>
                  <p class="mb-1"><strong>Stud Fee:</strong> <em><%= number_to_currency(horse.stud_fee) %></em></p>
                  <%= link_to "View Details", horse_path(horse), class: "btn btn-primary mt-3" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right Column: Sticky Map -->
    <div class="col-md-4 mt-4">
      <div class="sticky-top mt-5" style="top: 70px;">
        <div id="map-index"
             style="height: 600px; border: 2px dashed #ccc;"
             data-controller="map"
             data-map-markers-value='<%= @horses.geocoded.map do |horse|
                {
                  lat: horse.latitude,
                  lng: horse.longitude,
                  info_window_html: render_info_window(horse)
                }
              end.to_json %>'
             data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
        </div>
      </div>
    </div>
  </div>
</div>
